<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cozy Study Island</title>
  <style>
    :root {
      --green-dark: #355341;
      --green-mid: #7fb496;
      --green-light: #d8efe3;
      --cream: #fdf8ee;
      --border-soft: #a8c8b4;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #e9f7ef, #d8efe3, #c7e3d6);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    h1 {
      margin-top: 10px;
      font-size: 1.4rem;
      color: var(--green-dark);
      text-shadow: 0 1px 0 rgba(255,255,255,0.8);
    }

    main {
      display: flex;
      flex-direction: row;
      gap: 12px;
      padding-bottom: 16px;
    }

    .left-column {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    /* ==== UI BAR ==== */
    .ui-bar {
      width: 800px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 14px;
      background: rgba(249,253,250,0.98);
      border: 2px solid #b8d4c3;
      box-shadow: 0 4px 10px rgba(33,59,45,0.12);
      color: var(--green-dark);
    }

    .coins { font-weight: 600; }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e4f2e8;
      font-size: 0.75rem;
    }

    .study-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    input[type="number"] {
      width: 70px;
      padding: 5px 8px;
      border-radius: 9px;
      border: 1px solid #b2cfbd;
      text-align: center;
      font-size: 0.9rem;
      background: #f7fbf8;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      background: #9fd7b1;
      color: #254030;
      box-shadow: 0 2px 4px rgba(22,48,32,0.2);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.2s ease;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(22,48,32,0.25);
      background: #8dcca2;
    }

    button:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .owned-items {
      width: 800px;
      font-size: 0.8rem;
      background: rgba(251,255,252,0.96);
      border-radius: 12px;
      border: 1px dashed #b5ccb8;
      padding: 6px 10px;
      color: #3c5644;
    }

    /* ==== GAME AREA ==== */
    .game {
      position: relative;
      width: 800px;
      height: 450px;
      border-radius: 20px;
      overflow: hidden;
      border: 3px solid var(--border-soft);
      box-shadow: 0 6px 16px rgba(44,71,56,0.18);
      background-repeat: no-repeat;
      background-position: 0 0;
      background-size: cover;
      transition: background 0.3s ease;
    }

    .game.outside-view {
      background-image: url("img/forest_world_large.png");
      /* this image should be BIGGER than 800x450, e.g. 2000x2000 */
      background-size: 2000px 2000px;
    }

    .game.room-view {
      background-image: linear-gradient(#fdf8ee 62%, #e2cbb0 62%);
      background-size: cover;
    }

    #player {
      position: absolute;
      width: 80px;
      height: 110px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    #player img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      image-rendering: auto;
    }

    /* Room items */
    #roomItemsLayer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: none;
      padding-bottom: 40px;
    }

    .game.room-view #roomItemsLayer {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 16px;
    }

    .room-item {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      background: rgba(255,255,255,0.9);
      border: 2px solid #cddbc5;
      box-shadow: 0 3px 6px rgba(0,0,0,0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    /* ==== OVERLAYS ==== */
    .overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
      padding: 20px;
      z-index: 10;
    }

    .overlay-box {
      background: rgba(39,56,46,0.97);
      border-radius: 22px;
      padding: 22px 30px;
      min-width: 280px;
      max-width: 520px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }

    /* Character select */
    #characterOverlay .overlay-box {
      background: linear-gradient(145deg, #324a3b, #283835);
    }

    #characterOverlay .characters {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .char-card {
      width: 100px;
      height: 140px;
      border-radius: 22px;
      background: #f4fbf6;
      border: 2px solid #c5e2cf;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, border-color 0.1s ease;
      color: var(--green-dark);
    }

    .char-card img {
      width: 70px;
      height: 90px;
      object-fit: contain;
    }

    .char-card small {
      font-size: 0.7rem;
    }

    .char-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.18);
      border-color: var(--green-mid);
    }

    /* Study overlay */
    #studyTimerDisplay {
      font-size: 2.1rem;
      margin: 10px 0;
    }

    #bubbleContainer {
      position: relative;
      width: 100%;
      height: 150px;
      margin-top: 10px;
      overflow: hidden;
    }

    .leaf-bubble {
      position: absolute;
      bottom: -40px;
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.16);
      border: 1px solid rgba(255,255,255,0.85);
      backdrop-filter: blur(5px);
      font-size: 1.4rem;
      animation: floatUp 4s ease-out forwards;
    }

    @keyframes floatUp {
      0%   { transform: translateY(0)   scale(0.8); opacity: 0.1; }
      20%  { opacity: 1; }
      100% { transform: translateY(-140px) scale(1.1); opacity: 0; }
    }

    /* Shop overlay (kept simple here) */
    #shopOverlay .overlay-box {
      background: radial-gradient(circle at top, #f2fbf5, #e9f1ff);
      color: #33483b;
    }

    .shop-items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .shop-item {
      width: 120px;
      border-radius: 22px;
      background: #fff;
      border: 2px solid #cbe0cc;
      padding: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
    }

    .shop-item-emoji { font-size: 1.8rem; }
    .shop-item button { padding: 4px 10px; font-size: 0.75rem; background:#f6cfdc; }
  </style>
</head>
<body>
  <h1>Cozy Study Island</h1>

  <main>
    <div class="left-column">
      <!-- UI BAR -->
      <div class="ui-bar">
        <div>
          <div class="coins">
            Logged in as: <span id="currentUserLabel">Player</span> Â·
            Currency: <span id="coinCount">0</span> ðŸŒ¿
          </div>
          <div class="badge">1 minute = 1 ðŸŒ¿ Â· Focus to grow your forest</div>
        </div>

        <div class="study-controls">
          Study for
          <input type="number" id="minutesInput" min="1" value="5" /> min
          <button id="startStudyBtn">Start Study</button>
          <button id="openShopBtn">Shop</button>
          <button id="toggleViewBtn">Go to Room</button>
        </div>
      </div>

      <div class="owned-items">
        Owned items: <span id="ownedItemsList">none yet</span>
      </div>

      <!-- GAME AREA -->
      <div class="game outside-view" id="gameArea">
        <div id="player">
          <img id="playerSprite" src="img/char_girl1.png" alt="player" />
        </div>
        <div id="roomItemsLayer"></div>

        <!-- CHARACTER SELECT -->
        <div class="overlay" id="characterOverlay">
          <div class="overlay-box">
            <h2>Choose Your Character</h2>
            <p style="font-size:0.85rem;">Pick one cozy mushroom kid:</p>
            <div class="characters">
              <div class="char-card" data-char-id="girl1" data-src="img/char_girl1.png">
                <img src="img/char_girl1.png" alt="Girl 1" />
                <small>Girl 1</small>
              </div>
              <div class="char-card" data-char-id="girl2" data-src="img/char_girl2.png">
                <img src="img/char_girl2.png" alt="Girl 2" />
                <small>Girl 2</small>
              </div>
              <div class="char-card" data-char-id="boy1" data-src="img/char_boy1.png">
                <img src="img/char_boy1.png" alt="Boy 1" />
                <small>Boy 1</small>
              </div>
              <div class="char-card" data-char-id="boy2" data-src="img/char_boy2.png">
                <img src="img/char_boy2.png" alt="Boy 2" />
                <small>Boy 2</small>
              </div>
            </div>
          </div>
        </div>

        <!-- STUDY OVERLAY -->
        <div class="overlay" id="studyOverlay">
          <div class="overlay-box">
            <h2>Study Time!</h2>
            <p>Focus on your real-life work until the timer ends to earn ðŸŒ¿.</p>
            <div id="studyTimerDisplay">00:00</div>
            <p style="font-size:0.8rem;">You canâ€™t move or shop while studying.</p>
            <div id="bubbleContainer"></div>
          </div>
        </div>

        <!-- SHOP OVERLAY (simplified) -->
        <div class="overlay" id="shopOverlay">
          <div class="overlay-box">
            <h2>Forest Shop</h2>
            <p style="font-size:0.85rem;">Spend your ðŸŒ¿ on cozy decor.</p>
            <div class="shop-items" id="shopItemsContainer"></div>
            <div class="shop-footer">
              Remaining: <span id="shopCoinsDisplay">0</span> ðŸŒ¿
              <br /><br />
              <button id="closeShopBtn">Close Shop</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /* ====== SIMPLE FRONT-END STATE (backend should overwrite this) ====== */
    const playerState = {
      name: 'Player',           // TODO: set from Firebase user
      currency: 0,
      characterId: 'girl1',
      items: [],
      totalMinutesStudied: 0,
      completedSessions: 0
    };

    // Character definitions using your sprites
    const characters = {
      girl1: { id: 'girl1', src: 'img/char_girl1.png' },
      girl2: { id: 'girl2', src: 'img/char_girl2.png' },
      boy1:  { id: 'boy1',  src: 'img/char_boy1.png'  },
      boy2:  { id: 'boy2',  src: 'img/char_boy2.png'  }
    };

    // Shop items (example)
    const shopItems = [
      { id: 'flower_hat',    name: 'Flower Hat',      price: 10, emoji: 'ðŸŒ¼' },
      { id: 'mushroom_lamp', name: 'Mushroom Lamp',   price: 20, emoji: 'ðŸ„' },
      { id: 'leaf_rug',      name: 'Leaf Rug',        price: 12, emoji: 'ðŸƒ' },
      { id: 'tea_set',       name: 'Tea Set',         price: 15, emoji: 'ðŸµ' }
    ];

    /* ====== DOM ====== */
    const gameArea          = document.getElementById('gameArea');
    const playerSprite      = document.getElementById('playerSprite');
    const roomItemsLayer    = document.getElementById('roomItemsLayer');
    const coinCountSpan     = document.getElementById('coinCount');
    const currentUserLabel  = document.getElementById('currentUserLabel');
    const ownedItemsList    = document.getElementById('ownedItemsList');
    const minutesInput      = document.getElementById('minutesInput');
    const startBtn          = document.getElementById('startStudyBtn');
    const openShopBtn       = document.getElementById('openShopBtn');
    const toggleViewBtn     = document.getElementById('toggleViewBtn');
    const studyOverlay      = document.getElementById('studyOverlay');
    const studyTimerDisplay = document.getElementById('studyTimerDisplay');
    const bubbleContainer   = document.getElementById('bubbleContainer');
    const shopOverlay       = document.getElementById('shopOverlay');
    const shopItemsContainer= document.getElementById('shopItemsContainer');
    const shopCoinsDisplay  = document.getElementById('shopCoinsDisplay');
    const closeShopBtn      = document.getElementById('closeShopBtn');
    const characterOverlay  = document.getElementById('characterOverlay');

    /* ====== MAP / MOVEMENT ====== */

    // Viewport size (matches CSS)
    const VIEW_W = 800;
    const VIEW_H = 450;

    // Size of your background image (set same as background-size in CSS)
    const WORLD_W = 2000;
    const WORLD_H = 2000;

    // Player world coordinates (start in center)
    let playerX = WORLD_W / 2;
    let playerY = WORLD_H / 2;

    let isStudying = false;
    let isInRoom   = false;

    function updateBackgroundPosition() {
      // keep player visually centered, move map instead
      const offsetX = -(playerX - VIEW_W / 2);
      const offsetY = -(playerY - VIEW_H / 2);
      gameArea.style.backgroundPosition = `${offsetX}px ${offsetY}px`;
    }

    document.addEventListener('keydown', (e) => {
      if (isStudying || isInRoom) return;

      const key = e.key.toLowerCase();
      const speed = 12;
      let moved = false;

      if (key === 'arrowup' || key === 'w') {
        playerY -= speed; moved = true;
      } else if (key === 'arrowdown' || key === 's') {
        playerY += speed; moved = true;
      } else if (key === 'arrowleft' || key === 'a') {
        playerX -= speed; moved = true;
      } else if (key === 'arrowright' || key === 'd') {
        playerX += speed; moved = true;
      }

      if (moved) {
        // Clamp so you canâ€™t scroll past edges of the map
        const margin = 100; // how close you can get to outer trees
        playerX = Math.max(margin, Math.min(WORLD_W - margin, playerX));
        playerY = Math.max(margin, Math.min(WORLD_H - margin, playerY));
        updateBackgroundPosition();
        // FUTURE: here you can add "path" logic using a tilemap if you want
      }
    });

    /* ====== CHARACTER SELECT ====== */
    document.querySelectorAll('.char-card').forEach(card => {
      card.addEventListener('click', () => {
        const id  = card.dataset.charId;
        const src = card.dataset.src;
        playerState.characterId = id;
        playerSprite.src = src;
        // TODO: save to Firebase here
        characterOverlay.style.display = 'none';
      });
    });

    /* ====== STUDY TIMER (1 minute = 1 ðŸŒ¿) ====== */
    let timerId = null;
    let remainingSeconds = 0;

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function spawnBubble() {
      const bubble = document.createElement('div');
      bubble.className = 'leaf-bubble';
      bubble.textContent = 'ðŸŒ¿';
      const left = 10 + Math.random() * 80;
      const scale = 0.9 + Math.random() * 0.4;
      bubble.style.left = `${left}%`;
      bubble.style.transform = `scale(${scale})`;
      bubbleContainer.appendChild(bubble);
      bubble.addEventListener('animationend', () => bubble.remove());
    }

    startBtn.addEventListener('click', () => {
      if (isStudying) return;
      const minutes = parseInt(minutesInput.value, 10);
      if (!minutes || minutes <= 0) {
        alert('Enter a positive number of minutes.');
        return;
      }

      isStudying = true;
      remainingSeconds = minutes * 60;
      studyTimerDisplay.textContent = formatTime(remainingSeconds);
      studyOverlay.style.display = 'flex';
      bubbleContainer.innerHTML = '';

      // lock controls
      startBtn.disabled = true;
      openShopBtn.disabled = true;
      toggleViewBtn.disabled = true;

      const reward = minutes; // 1 min = 1 ðŸŒ¿

      timerId = setInterval(() => {
        remainingSeconds--;
        studyTimerDisplay.textContent = formatTime(remainingSeconds);
        if (remainingSeconds > 0) spawnBubble();

        if (remainingSeconds <= 0) {
          clearInterval(timerId);
          timerId = null;
          isStudying = false;
          studyOverlay.style.display = 'none';

          startBtn.disabled = false;
          openShopBtn.disabled = false;
          toggleViewBtn.disabled = false;

          playerState.currency += reward;
          playerState.totalMinutesStudied += reward;
          playerState.completedSessions += 1;
          updateHUD();
          // TODO: save to Firebase here

          alert(`Nice work, ${playerState.name}! You earned ${reward} ðŸŒ¿.`);
        }
      }, 1000);
    });

    /* ====== SHOP (graphics only, simple) ====== */
    function renderShopItems() {
      shopItemsContainer.innerHTML = '';
      shopItems.forEach(item => {
        const owned = playerState.items.includes(item.id);
        const div = document.createElement('div');
        div.className = 'shop-item';

        const em = document.createElement('div');
        em.className = 'shop-item-emoji';
        em.textContent = item.emoji;

        const name = document.createElement('div');
        name.textContent = item.name;

        const price = document.createElement('div');
        price.textContent = `${item.price} ðŸŒ¿`;

        const btn = document.createElement('button');
        btn.textContent = owned ? 'Owned' : 'Buy';
        btn.disabled = owned;

        btn.addEventListener('click', () => {
          if (owned) return;
          if (playerState.currency < item.price) {
            alert('Not enough ðŸŒ¿!');
            return;
          }
          playerState.currency -= item.price;
          playerState.items.push(item.id);
          updateHUD();
          renderRoomItems();
          renderShopItems();
          // TODO: save to Firebase
        });

        div.appendChild(em);
        div.appendChild(name);
        div.appendChild(price);
        div.appendChild(btn);
        shopItemsContainer.appendChild(div);
      });
    }

    openShopBtn.addEventListener('click', () => {
      if (isStudying) return;
      shopCoinsDisplay.textContent = playerState.currency;
      renderShopItems();
      shopOverlay.style.display = 'flex';
    });

    closeShopBtn.addEventListener('click', () => {
      shopOverlay.style.display = 'none';
    });

    /* ====== ROOM VIEW ====== */
    toggleViewBtn.addEventListener('click', () => {
      if (isStudying) return;
      isInRoom = !isInRoom;
      if (isInRoom) {
        gameArea.classList.remove('outside-view');
        gameArea.classList.add('room-view');
        toggleViewBtn.textContent = 'Go Outside';
      } else {
        gameArea.classList.remove('room-view');
        gameArea.classList.add('outside-view');
        toggleViewBtn.textContent = 'Go to Room';
        updateBackgroundPosition();
      }
    });

    function renderRoomItems() {
      roomItemsLayer.innerHTML = '';
      playerState.items.forEach(id => {
        const item = shopItems.find(i => i.id === id);
        if (!item) return;
        const div = document.createElement('div');
        div.className = 'room-item';
        div.textContent = item.emoji;
        roomItemsLayer.appendChild(div);
      });
    }

    /* ====== HUD UPDATE & INIT ====== */
    function updateHUD() {
      currentUserLabel.textContent = playerState.name;
      coinCountSpan.textContent = playerState.currency;
      ownedItemsList.textContent =
        playerState.items.length === 0
          ? 'none yet'
          : playerState.items
              .map(id => {
                const item = shopItems.find(i => i.id === id);
                return item ? `${item.emoji} ${item.name}` : id;
              })
              .join(', ');
      shopCoinsDisplay.textContent = playerState.currency;
    }

    function init() {
      // TODO: your partner can overwrite playerState here with Firebase data,
      // then call updateHUD() and maybe hide characterOverlay if character chosen
      updateHUD();
      updateBackgroundPosition();
      characterOverlay.style.display = 'flex'; // show once at start
      renderRoomItems();
    }

    init();
  </script>
</body>
</html>
